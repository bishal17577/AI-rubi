<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>QR Ultimate Suite - Upgraded</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        html[data-theme="dark"] {
            --primary-color: #0d6efd;
            --primary-hover: #3385fd;
            --background-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
        }
        html[data-theme="high-contrast"] {
            --primary-color: #00ffff;
            --primary-hover: #00dddd;
            --background-color: #000000;
            --card-bg: #111;
            --text-color: #ffffff;
            --border-color: #888;
            --success-color: #00ff00;
            --danger-color: #ff0000;
        }
        html.glassmorphism[data-theme="light"] {
            --card-bg: rgba(255, 255, 255, 0.6);
            --background-color: #e0e8ff;
        }
        html.glassmorphism[data-theme="dark"] {
            --card-bg: rgba(30, 30, 30, 0.6);
            --background-color: #1a1a2e;
        }
        body { font-family: var(--font-family); margin: 0; background-color: var(--background-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; font-size: 14px; background-image: var(--bg-image); background-attachment: fixed; }
        .app-container { touch-action: pan-y; padding: 12px; padding-bottom: 90px; max-width: 700px; margin: auto; }
        .page { display: none; text-align: center; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border: 1px solid var(--border-color); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); transition: background-color 0.3s, border-color 0.3s; }
        h2 { font-size: 1.4em; } h3 { font-size: 1.2em; margin-top: 20px; margin-bottom: 10px;}
        nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; justify-content: space-around; backdrop-filter: blur(10px); }
        nav button { background: none; border: none; color: var(--secondary-color); padding: 6px 2px; font-size: 9px; cursor: pointer; flex-grow: 1; transition: color 0.3s; max-width: 25%; }
        nav button.active { color: var(--primary-color); }
        nav i { font-size: 16px; display: block; margin-bottom: 4px; }
        video { max-width: 100%; width: 280px; border-radius: 8px; border: 1px solid var(--border-color); }
        input, textarea, select { width: calc(100% - 20px); padding: 8px 9px; font-size: 13px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); }
        .btn { padding: 6px 10px; font-size: 13px; margin: 2px; border-radius: 6px; border: none; cursor: pointer; color: white; transition: background-color 0.3s, transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-color); } .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); } .btn-danger { background-color: var(--danger-color); } .btn-success { background-color: var(--success-color); }
        .btn i { margin-right: 5px; }
        #generator-page .btn-primary[onclick*="generateQR"] { padding: 10px !important; font-size: 15px !important; }
        #qr-output-wrapper { position: relative; display: inline-block; margin-top: 15px; }
        .qr-glow { filter: drop-shadow(0 0 10px var(--primary-color)); }
        #qr-output-frame { border: 10px solid #333; padding: 10px; display: none; border-image-slice: 1; }
        #qr-output-caption { display: none; font-style: italic; margin-top: 8px; font-size: 12px; }
        .history-entry { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding: 8px 5px; text-align: left; }
        .history-entry.pinned { background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); }
        .history-actions { display: flex; gap: 5px; }
        .form-group { margin-bottom: 12px; text-align: left; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 13px; }
        .form-group.inline { display: flex; justify-content: space-between; align-items: center; }
        .pin-lock-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .generator-field { display: none; } .generator-field.active { display: block; animation: fadeIn 0.5s; }
        .fieldset-toggle { border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-top: 15px; }
        .fieldset-toggle legend { cursor: pointer; font-weight: bold; font-size: 14px; }
        .fieldset-toggle .fieldset-content { display: none; }
        #scan-result-modal { display: none; position: fixed; z-index: 10001; left:0; top:0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); justify-content: center; align-items: center;}
        #scan-result-content { max-width: 90%; width: 400px; }
        #qr-scanner-container { width: 100%; max-width: 400px; margin: auto; }
        #qr-file-drop-zone { border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; margin-top: 15px; cursor: pointer; }
        #qr-file-drop-zone.dragover { background-color: color-mix(in srgb, var(--primary-color) 20%, transparent); }
        #history-controls { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        #history-search { flex-grow: 1; }
        #anti-screenshot-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 100000; opacity: 0; pointer-events: none; }
        @media print { #anti-screenshot-overlay { opacity: 1 !important; } }
    </style>
    <!-- Custom User CSS -->
    <style id="custom-user-css"></style>
</head>
<body>
    <div id="anti-screenshot-overlay"></div>
    <!-- Overlays -->
    <div id="pin-lock-overlay" class="pin-lock-overlay" style="display: none;"><div class="card" style="width: 280px; text-align: center;"><h3 id="pin-title">Enter PIN</h3><input type="password" id="pin-input" placeholder="****" maxlength="4" style="text-align: center; font-size: 18px;"><button id="pin-submit" class="btn btn-primary">Unlock</button><div id="pin-error" style="color: var(--danger-color); margin-top: 10px; min-height: 1em;"></div></div></div>
    <div id="scan-result-modal" onclick="closeModal('scan-result-modal')"><div class="card" id="scan-result-content" onclick="event.stopPropagation()"></div></div>

    <div class="app-container"><div id="page-container"></div></div>

    <!-- NEW NAVIGATION -->
    <nav>
        <button id="nav-generator" onclick="showPage('generator')"><i class="fas fa-cogs"></i>Generate</button>
        <button id="nav-features" onclick="showPage('features')"><i class="fas fa-star"></i>Features</button>
        <button id="nav-history" onclick="showPage('history')"><i class="fas fa-history"></i>History</button>
        <button id="nav-settings" onclick="showPage('settings')"><i class="fas fa-user-cog"></i>Settings</button>
    </nav>

    <!-- HTML Page Templates -->
    <!-- Generator Page: Now includes Advanced Security -->
    <template id="generator-page-template">
        <div class="page" id="generator-page">
            <h2>Smart QR Generator</h2>
            <div class="card">
                <div class="form-group">
                    <label for="qr-type-selector">QR Code Type</label>
                    <select id="qr-type-selector" onchange="showGeneratorFields(this.value)">
                        <option value="text">Plain Text</option><option value="url">URL/Link</option><option value="vcard">vCard (Contact)</option><option value="wifi">Wi-Fi</option><option value="email">Email</option><option value="sms">SMS</option><option value="event">Calendar Event</option><option value="geo">Geo Location</option>
                    </select>
                </div>
                <div id="generator-fields">
                    <div id="field-text" class="generator-field">
                        <div style="position: relative;">
                            <textarea id="text-input" placeholder="Your text here" rows="4"></textarea>
                            <button class="btn btn-secondary" onclick="pasteFromClipboard('text-input')" style="position: absolute; right: 0; top: 0;"><i class="fas fa-paste"></i></button>
                            <button class="btn btn-secondary" onclick="startSpeechRecognition('text-input')" style="position: absolute; right: 45px; top: 0;"><i class="fas fa-microphone"></i></button>
                        </div>
                    </div>
                    <!-- Other fields are the same, just condensed for brevity -->
                    <div id="field-url" class="generator-field"><input type="url" id="url-input" placeholder="https://example.com"></div>
                    <div id="field-vcard" class="generator-field"><input type="text" id="vcard-fname" placeholder="First Name"><input type="tel" id="vcard-tel" placeholder="Phone"><input type="email" id="vcard-email" placeholder="Email"></div>
                    <div id="field-wifi" class="generator-field"><input type="text" id="wifi-ssid" placeholder="SSID"><input type="text" id="wifi-pass" placeholder="Password"><select id="wifi-security"><option value="WPA">WPA/WPA2</option><option value="WEP">WEP</option><option value="nopass">No Password</option></select></div>
                    <div id="field-email" class="generator-field"><input type="email" id="email-to" placeholder="To: email@example.com"><input type="text" id="email-subject" placeholder="Subject"><textarea id="email-body" placeholder="Body"></textarea></div>
                    <div id="field-sms" class="generator-field"><input type="tel" id="sms-to" placeholder="Phone Number"><textarea id="sms-body" placeholder="Message"></textarea></div>
                    <div id="field-event" class="generator-field"><input type="text" id="event-title" placeholder="Event Title"><label>Start</label><input type="datetime-local" id="event-start"><label>End</label><input type="datetime-local" id="event-end"></div>
                    <div id="field-geo" class="generator-field"><input type="text" id="geo-lat" placeholder="Latitude"><input type="text" id="geo-lon" placeholder="Longitude"></div>
                </div>
            </div>

            <div class="card">
                <!-- Design Fieldset (Unchanged logic) -->
                <fieldset class="fieldset-toggle" id="design-fieldset">
                    <legend onclick="toggleFieldset('design-fieldset')"><i class="fas fa-palette"></i> QR Design & Customization <i class="fas fa-chevron-down"></i></legend>
                    <div class="fieldset-content">
                        <div class="form-group"><label>Dots Style</label><select id="qr-dots-style"><option value="rounded">Rounded</option><option value="dots">Dots</option><option value="classy">Classy</option><option value="square">Square</option></select></div>
                        <div class="form-group inline"><label>Primary Color</label><input type="color" id="qr-color-dark" value="#000000"></div>
                        <div class="form-group inline"><label>Background</label><input type="color" id="qr-color-light" value="#ffffff"></div>
                        <div class="form-group"><label>Logo Image / Emoji</label><input type="file" id="qr-logo-file" accept="image/*"><input type="text" id="qr-logo-emoji" placeholder="Or enter an emoji here"></div>
                    </div>
                </fieldset>

                <!-- NEW: Advanced Security Fieldset -->
                <fieldset class="fieldset-toggle" id="security-fieldset">
                    <legend onclick="toggleFieldset('security-fieldset')"><i class="fas fa-shield-alt"></i> Advanced Security <i class="fas fa-chevron-down"></i></legend>
                    <div class="fieldset-content">
                        <div class="form-group">
                            <label for="secure-pass">Password-Protect QR (Encrypts Data)</label>
                            <input type="password" id="secure-pass" placeholder="Leave blank for no password">
                        </div>
                        <div class="form-group">
                            <label for="secure-limit">Scan Count Limiter</label>
                            <select id="secure-limit"><option value="0">Unlimited</option><option value="1">1 Scan</option><option value="3">3 Scans</option><option value="5">5 Scans</option></select>
                        </div>
                         <div class="form-group inline">
                            <label for="secure-geo">Geo-restrict to my location</label>
                            <input type="checkbox" id="secure-geo">
                        </div>
                        <div class="form-group inline">
                            <label for="secure-screenshot">Anti-Screenshot Overlay</label>
                            <input type="checkbox" id="secure-screenshot">
                        </div>
                        <p style="font-size: 11px; color: var(--secondary-color);">Note: These security features are client-side and depend on the user scanning with this app. Standard camera apps will read the raw (encrypted) data.</p>
                    </div>
                </fieldset>

                <div id="qr-output-wrapper" class="qr-glow"><div id="qr-output"></div></div>
                <button class="btn btn-primary" onclick="generateQR(false)" style="width: 100%;"><i class="fas fa-qrcode"></i> Generate & Save</button>
                <div id="download-buttons" style="margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="downloadQR('png')"><i class="fas fa-file-image"></i> PNG</button>
                    <button class="btn btn-secondary" onclick="downloadQR('svg')"><i class="fas fa-file-code"></i> SVG</button>
                    <button class="btn btn-secondary" onclick="shareQR()"><i class="fas fa-share-alt"></i> Share</button>
                    <button class="btn btn-secondary" onclick="toggleFullscreen('qr-output-wrapper')"><i class="fas fa-expand"></i> Fullscreen</button>
                </div>
            </div>
        </div>
    </template>

    <!-- NEW: Features Page (replaces Scan/Connect) -->
    <template id="features-page-template">
        <div class="page" id="features-page">
            <h2>Features Hub</h2>
            <div class="card">
                <h3><i class="fas fa-qrcode"></i> Scan a QR Code</h3>
                <div id="qr-scanner-container"></div>
                <div id="qr-file-drop-zone">
                    <i class="fas fa-upload fa-2x"></i>
                    <p>Drag & drop a QR image, or click to select file.</p>
                </div>
                <input type="file" id="qr-file-input" accept="image/png, image/jpeg, image/gif" style="display:none;">
            </div>

            <div class="card">
                <h3><i class="fas fa-tools"></i> Utility Tools</h3>
                <!-- TODO: Implement remaining utility features -->
                <button class="btn btn-primary" onclick="alert('TODO: Implement QR to Barcode converter (#20)')"><i class="fas fa-barcode"></i> QR to Barcode</button>
                <button class="btn btn-primary" onclick="alert('TODO: Implement Voice to QR (#17)')"><i class="fas fa-microphone-alt"></i> Voice Memo QR</button>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-dice"></i> Fun & Experimental</h3>
                <button class="btn btn-success" onclick="generateFunQR('8ball')"><i class="fas fa-magic"></i> Magic 8-Ball</button>
                <button class="btn btn-success" onclick="generateFunQR('fortune')"><i class="fas fa-cookie-bite"></i> Fortune Cookie</button>
                <button class="btn btn-success" onclick="generateFunQR('rickroll')"><i class="fas fa-video"></i> Prank QR</button>
            </div>
        </div>
    </template>

    <!-- History Page: Now with search, sort, pin, tags -->
    <template id="history-page-template">
        <div class="page" id="history-page">
            <h2><i class="fas fa-history"></i> Generation History</h2>
            <div id="history-controls">
                <input type="search" id="history-search" placeholder="Search by content or tag...">
                <select id="history-sort">
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc">Oldest First</option>
                </select>
            </div>
             <button class="btn btn-secondary" onclick="exportHistory()"><i class="fas fa-file-export"></i> Export as JSON</button>
            <div class="card" id="generation-history-container" style="max-height: 400px; overflow-y: auto; text-align: left;"></div>
        </div>
    </template>

    <!-- Settings Page: Now with Themes, PWA install, custom CSS -->
    <template id="settings-page-template">
        <div class="page" id="settings-page">
            <h2><i class="fas fa-user-cog"></i> Settings</h2>
            <div class="card">
                <h3><i class="fas fa-palette"></i> Personalization</h3>
                <div class="form-group"><label>Theme</label>
                    <select id="theme-selector" onchange="applyTheme(this.value); saveState();">
                        <option value="light">Light</option><option value="dark">Dark</option><option value="high-contrast">High Contrast</option>
                    </select>
                </div>
                 <div class="form-group"><label>Font Style</label>
                    <select id="font-selector" onchange="applyFont(this.value)">
                        <option value="sans-serif">Sans-Serif</option><option value="serif">Serif</option><option value="monospace">Monospace</option>
                    </select>
                </div>
                <div class="form-group inline"><label for="glassmorphism-toggle">Glassmorphism UI</label><input type="checkbox" id="glassmorphism-toggle" onchange="toggleStyleClass('glassmorphism', this.checked)"></div>
                <div class="form-group"><label>Custom CSS</label><textarea id="custom-css-editor" rows="3" placeholder="/* e.g., .btn { border-radius: 0; } */" oninput="applyCustomCSS(this.value)"></textarea></div>
            </div>
            <div class="card">
                <h3><i class="fas fa-mobile-alt"></i> App</h3>
                <button class="btn btn-primary" id="install-pwa-btn"><i class="fas fa-download"></i> Install App (PWA)</button>
                <p style="font-size:11px;">Add this app to your home screen for offline access and a native feel.</p>
            </div>
            <div class="card">
                <h3><i class="fas fa-shield-alt"></i> Security</h3>
                <div class="form-group"><label>Set 4-Digit PIN to Lock App</label><input type="password" id="pin-input-setup" placeholder="Enter 4 digits" maxlength="4"><button class="btn btn-primary" onclick="savePin()">Save PIN</button></div>
            </div>
            <div class="card">
                <h3><i class="fas fa-database"></i> Data Management</h3>
                <button class="btn btn-danger" onclick="if(confirm('This will delete ALL data. Are you sure?')) { localStorage.clear(); location.reload(); }"><i class="fas fa-trash-alt"></i> Clear All App Data</button>
            </div>
        </div>
    </template>
    
    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Main Application Logic (JavaScript) -->
       <!-- Main Application Logic (JavaScript) -->
           <!-- Main Application Logic (JavaScript) -->
    <script>
        let html5QrCode; 
        let deferredInstallPrompt;
        
        const appState = {
            activePage: 'generator',
            qrCodeInstance: null,
            scannedData: [], 
            generationHistory: [], 
            settings: {
                theme: 'light', font: 'sans-serif', glassmorphism: false, customCSS: '',
                pinLock: '',
                defaultQrType: 'text',
            },
            scanCounts: {} 
        };
    
        window.lastScannedContent = '';
    
        // --- Core App Logic (Initialization, State, Routing) ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            checkPinLock();
            initPWA();
            initSwipeGestures();
        });
    
        function checkPinLock() { 
            if (appState.settings.pinLock) {
                const overlay = document.getElementById('pin-lock-overlay');
                overlay.style.display = 'flex';
                document.getElementById('pin-submit').onclick = () => {
                    const input = document.getElementById('pin-input');
                    const pinError = document.getElementById('pin-error');
                    if (input.value === appState.settings.pinLock) {
                        overlay.style.display = 'none';
                        initializeApp();
                    } else {
                        pinError.textContent = 'Incorrect PIN.'; input.value = ''; input.focus();
                    }
                };
            } else {
                initializeApp();
            }
        }
    
        function initializeApp() {
            showPage(appState.activePage);
            applyTheme(appState.settings.theme);
            applyFont(appState.settings.font);
            toggleStyleClass('glassmorphism', appState.settings.glassmorphism);
            applyCustomCSS(appState.settings.customCSS);
            document.addEventListener('input', (e) => {
                if (appState.activePage === 'generator' && e.target.closest('#generator-page .card')) {
                    generateQR(true);
                }
            });
        }
    
        function saveState() {
            localStorage.setItem('qrAppState', JSON.stringify(appState));
        }
    
        // *** FIXED: This function is now robust and will not crash on invalid stored data. ***
        function loadState() {
            try {
                const savedState = localStorage.getItem('qrAppState');
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                    // Defensively check if the parsed data is a valid object
                    if (parsed && typeof parsed === 'object') {
                        // Merge settings safely
                        if (parsed.settings && typeof parsed.settings === 'object') {
                            Object.assign(appState.settings, parsed.settings);
                        }
                        appState.activePage = parsed.activePage || 'generator';
                        appState.generationHistory = Array.isArray(parsed.generationHistory) ? parsed.generationHistory : [];
                        appState.scanCounts = (parsed.scanCounts && typeof parsed.scanCounts === 'object') ? parsed.scanCounts : {};
                    }
                }
            } catch (e) {
                console.error("Could not load or parse state from localStorage. Starting with a fresh state.", e);
                // If parsing fails, it's best to clear the corrupted item to prevent future errors.
                localStorage.removeItem('qrAppState');
            }
        }
        
        function showPage(pageId) {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Error stopping scanner:", err));
            }
            appState.activePage = pageId;
            const pageContainer = document.getElementById('page-container');
            const template = document.getElementById(`${pageId}-page-template`);
            if (!template) return;
            
            pageContainer.innerHTML = template.innerHTML;
            const newPage = pageContainer.querySelector('.page');
            if (newPage) newPage.classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
    
            if (pageId === 'generator') initGeneratorPage();
            if (pageId === 'features') initFeaturesPage();
            if (pageId === 'history') renderGenerationHistory();
            if (pageId === 'settings') initSettingsPage();
            
            saveState();
            vibrate(20);
        }
        
        // --- PWA & Mobile ---
        function initPWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js').catch(err => console.error('Service Worker registration failed:', err));
            }
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredInstallPrompt = e;
                const installBtn = document.getElementById('install-pwa-btn');
                if(installBtn) installBtn.style.display = 'block';
            });
        }
    
        async function installPWA() {
            if (deferredInstallPrompt) {
                deferredInstallPrompt.prompt();
                const { outcome } = await deferredInstallPrompt.userChoice;
                deferredInstallPrompt = null;
                if(outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                }
            } else {
                alert("App can't be installed right now. It might be already installed or your browser doesn't support it.");
            }
        }
    
        function initSwipeGestures() {
            let touchstartX = 0;
            let touchendX = 0;
            const container = document.querySelector('.app-container');
    
            container.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, { passive: true });
            container.addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                handleSwipe();
            });
    
            function handleSwipe() {
                const navButtons = Array.from(document.querySelectorAll('nav button'));
                const currentIndex = navButtons.findIndex(btn => btn.classList.contains('active'));
                if (touchendX < touchstartX - 50) { // Swipe Left
                    const nextIndex = (currentIndex + 1) % navButtons.length;
                    navButtons[nextIndex].click();
                }
                if (touchendX > touchstartX + 50) { // Swipe Right
                    const prevIndex = (currentIndex - 1 + navButtons.length) % navButtons.length;
                    navButtons[prevIndex].click();
                }
            }
        }
        
        function vibrate(duration = 50) {
            if ('vibrate' in navigator) {
                navigator.vibrate(duration);
            }
        }
    
        function shareQR() {
            if (!appState.qrCodeInstance || !navigator.share) {
                alert('Web Share API not supported on this browser.');
                return;
            }
            appState.qrCodeInstance.toDataUrl('png').then(dataUrl => {
                fetch(dataUrl).then(res => res.blob()).then(blob => {
                    const file = new File([blob], 'qrcode.png', { type: 'image/png' });
                    navigator.share({
                        title: 'My QR Code',
                        text: 'Check out this QR code I made!',
                        files: [file]
                    }).catch(err => console.error('Share failed:', err));
                });
            });
        }
        
        function toggleFullscreen(elementId) {
            const elem = document.getElementById(elementId);
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`));
            } else {
                document.exitFullscreen();
            }
        }
    
        // --- Features Page (Scanner) ---
        function initFeaturesPage() {
            html5QrCode = new Html5Qrcode("qr-scanner-container");
            const startScanner = () => {
                 html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    (errorMessage) => { /* ignore errors */ }
                ).catch((err) => {
                    document.getElementById('qr-scanner-container').innerHTML = `<p style="color:var(--danger-color)">Could not start camera. Please grant permission. Error: ${err}</p>`;
                });
            }
            startScanner();
    
            const dropZone = document.getElementById('qr-file-drop-zone');
            const fileInput = document.getElementById('qr-file-input');
            
            dropZone.onclick = () => fileInput.click();
            fileInput.onchange = e => handleFileSelect(e.target.files);
            
            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
            dropZone.ondragleave = () => dropZone.classList.remove('dragover');
            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files);
            };
        }
    
        function handleFileSelect(files) {
            if (files.length === 0) return;
            html5QrCode.scanFile(files[0], true)
                .then(decodedText => onScanSuccess(decodedText))
                .catch(err => alert(`Error scanning file: ${err}`));
        }
        
        async function onScanSuccess(decodedText, decodedResult) {
            vibrate(100);
            let content = decodedText;
            let securityRules = {};
            
            if (content.startsWith('qrus_secure:')) {
                try {
                    const encryptedPayload = content.substring('qrus_secure:'.length);
                    const password = prompt("This QR code is password protected. Please enter the password:");
                    if (!password) {
                        showModalMessage("Scan Cancelled", "Password entry was cancelled.");
                        return;
                    }
                    const decryptedBytes = CryptoJS.AES.decrypt(encryptedPayload, password);
                    const decryptedJson = decryptedBytes.toString(CryptoJS.enc.Utf8);
                    if (!decryptedJson) throw new Error("Decryption failed. Wrong password?");
                    
                    const dataObject = JSON.parse(decryptedJson);
                    content = dataObject.payload;
                    securityRules = dataObject.rules || {};
    
                } catch (e) {
                    showModalMessage("Decryption Failed", `Could not decrypt the QR code. Error: ${e.message}`);
                    return;
                }
            }
            
            const qrHash = await digestMessage(content); 
    
            if (securityRules.limit > 0) {
                const currentCount = appState.scanCounts[qrHash] || 0;
                if (currentCount >= securityRules.limit) {
                    showModalMessage("Access Denied", `This QR code has reached its scan limit of ${securityRules.limit}.`);
                    return;
                }
                appState.scanCounts[qrHash] = currentCount + 1;
                saveState();
            }
    
            if (securityRules.geo) {
                try {
                    const userPos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 }));
                    const targetPos = securityRules.geo; 
                    const distance = getDistanceFromLatLonInKm(userPos.coords.latitude, userPos.coords.longitude, targetPos.lat, targetPos.lon);
                    if (distance > 50) {
                         showModalMessage("Access Denied", `This QR code is geo-restricted and you are too far away (${Math.round(distance)} km).`);
                         return;
                    }
                } catch(e) {
                    showModalMessage("Access Denied", `Could not verify your location for this geo-restricted QR code. Error: ${e.message}`);
                    return;
                }
            }
            
            window.lastScannedContent = content;
            
            let resultHTML = `<h3>Scan Result</h3><p style="word-break:break-all;">${escapeHTML(content)}</p>`;
            if (content.startsWith('http')) {
                resultHTML += `<a href="${content}" target="_blank" class="btn btn-primary">Open Link</a>`;
            }
            resultHTML += `<button class="btn btn-secondary" onclick="copyToClipboard(window.lastScannedContent)">Copy</button>`;
            resultHTML += `<button class="btn btn-secondary" onclick="readAloud(window.lastScannedContent)">Read Aloud</button>`;
            if (securityRules.screenshot) { document.getElementById('anti-screenshot-overlay').style.opacity = '1'; }
    
            showModalMessage('Scan Successful', resultHTML, () => {
                document.getElementById('anti-screenshot-overlay').style.opacity = '0';
            });
        }
    
        // --- Generator Page ---
        function initGeneratorPage() {
            const typeSelector = document.getElementById('qr-type-selector');
            typeSelector.value = appState.settings.defaultQrType;
            showGeneratorFields(typeSelector.value);
            generateQR(true);
        }
        
        function showGeneratorFields(type) {
            document.querySelectorAll('.generator-field').forEach(f => f.classList.remove('active'));
            document.getElementById(`field-${type}`).classList.add('active');
        }
        
        async function getQrData() {
            const type = document.getElementById('qr-type-selector').value;
            let data = '';
            switch (type) {
                case 'text': data = document.getElementById('text-input').value; break;
                case 'url': data = document.getElementById('url-input').value; break;
                case 'vcard': 
                    data = `BEGIN:VCARD\nVERSION:3.0\nFN:${document.getElementById('vcard-fname').value}\nTEL:${document.getElementById('vcard-tel').value}\nEMAIL:${document.getElementById('vcard-email').value}\nEND:VCARD`;
                    break;
                case 'wifi':
                    const ssid = document.getElementById('wifi-ssid').value;
                    const pass = document.getElementById('wifi-pass').value;
                    const security = document.getElementById('wifi-security').value;
                    data = `WIFI:T:${security};S:${ssid};P:${pass};;`;
                    break;
                default: data = document.getElementById('text-input').value; break;
            }
    
            const password = document.getElementById('secure-pass').value;
            if (password) {
                const limit = document.getElementById('secure-limit').value;
                const geo = document.getElementById('secure-geo').checked;
                let rules = {};
                if (limit > 0) rules.limit = parseInt(limit);
                if (geo) {
                     try {
                        const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, {timeout: 5000}));
                        rules.geo = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    } catch (e) {
                        alert("Could not get location for Geo-restriction. Please grant permission and try again.");
                        return null;
                    }
                }
                if (document.getElementById('secure-screenshot').checked) rules.screenshot = true;
    
                let secureObject = { payload: data, rules: rules };
                let secureJSON = JSON.stringify(secureObject);
                return 'qrus_secure:' + CryptoJS.AES.encrypt(secureJSON, password).toString();
            }
            
            return data;
        }
    
        async function generateQR(isPreview = false) {
            let data = await getQrData();
            if (data === null) return;
            const qrOutput = document.getElementById("qr-output");
            if (!data || !qrOutput) { if(qrOutput) qrOutput.innerHTML = ''; appState.qrCodeInstance = null; return; }
            
            const emoji = document.getElementById('qr-logo-emoji').value;
            let logoSrc = null;
            const logoFile = document.getElementById('qr-logo-file').files[0];
            if (logoFile) {
                logoSrc = URL.createObjectURL(logoFile);
            } else if (emoji) {
                logoSrc = emojiToDataUrl(emoji);
            }
            
            const options = {
                width: 300, height: 300, data: data,
                dotsOptions: { type: document.getElementById('qr-dots-style').value, color: document.getElementById('qr-color-dark').value },
                backgroundOptions: { color: document.getElementById('qr-color-light').value },
                image: logoSrc,
                imageOptions: { crossOrigin: "anonymous", margin: 5, imageSize: 0.4 }
            };
    
            qrOutput.innerHTML = '';
            appState.qrCodeInstance = new QRCodeStyling(options);
            appState.qrCodeInstance.append(qrOutput);
            
            if (!isPreview) {
                vibrate(50);
                appState.generationHistory.unshift({
                    id: Date.now(),
                    type: document.getElementById('qr-type-selector').value,
                    data: data, 
                    date: new Date().toISOString(),
                    tags: [],
                    isPinned: false
                });
                saveState();
                alert("QR generated and saved to history!");
            }
        }
    
        function downloadQR(format) {
            if (!appState.qrCodeInstance) return;
            const name = `qr-code-${Date.now()}`;
            appState.qrCodeInstance.download({ name: name, extension: format });
        }
    
        function generateFunQR(type) {
            let content = '';
            let showInGenerator = (data) => {
                showPage('generator');
                setTimeout(() => { 
                    document.getElementById('qr-type-selector').value = 'text';
                    showGeneratorFields('text');
                    document.getElementById('text-input').value = data;
                    generateQR(false);
                }, 100);
            }
    
            switch(type) {
                case '8ball':
                    const responses = ["It is certain.", "Without a doubt.", "Ask again later.", "Don't count on it.", "My sources say no."];
                    content = `Magic 8-Ball says: ${responses[Math.floor(Math.random() * responses.length)]}`;
                    break;
                case 'fortune':
                    const fortunes = ["A beautiful, smart, and loving person will be coming into your life.", "You will be unusually successful in business.", "Your life will be happy and peaceful."];
                    content = `Your Fortune: ${fortunes[Math.floor(Math.random() * fortunes.length)]}`;
                    break;
                case 'rickroll':
                    content = "https://www.youtube.com/watch?v=dQw4w9WgXcQ";
                    showPage('generator');
                    setTimeout(() => {
                        document.getElementById('qr-type-selector').value = 'url';
                        showGeneratorFields('url');
                        document.getElementById('url-input').value = content;
                        generateQR(false);
                    }, 100);
                    return;
            }
            showInGenerator(content);
        }
        
        // --- History Page ---
        function renderGenerationHistory() {
            const container = document.getElementById("generation-history-container");
            const searchInput = document.getElementById("history-search");
            const sortSelect = document.getElementById("history-sort");
            if(!container) return;
    
            let history = [...appState.generationHistory];
            const searchTerm = searchInput.value.toLowerCase();
            if(searchTerm) {
                history = history.filter(entry => 
                    entry.data.toLowerCase().includes(searchTerm) || 
                    (entry.tags && entry.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
            }
            history.sort((a,b) => b.isPinned - a.isPinned); 
            const sortValue = sortSelect.value;
            if(sortValue === 'date-desc') { history.sort((a, b) => new Date(b.date) - new Date(a.date)); }
            if(sortValue === 'date-asc') { history.sort((a, b) => new Date(a.date) - new Date(b.date)); }
    
            container.innerHTML = history.length > 0 ? '' : '<p style="padding: 10px;">No matching QR codes found.</p>';
            history.forEach(entry => {
                const div = document.createElement("div");
                div.className = `history-entry ${entry.isPinned ? 'pinned' : ''}`;
                const shortData = escapeHTML(entry.data.length > 80 ? entry.data.substring(0, 80) + '...' : entry.data);
                div.innerHTML = `
                    <div>
                        <small>${new Date(entry.date).toLocaleString()} - <b>${escapeHTML(entry.type.toUpperCase())}</b></small>
                        <p style="word-break:break-all; margin:4px 0; font-size:12px;">${shortData}</p>
                        <div class="tags-container">${(entry.tags || []).map(t => `<span>${escapeHTML(t)}</span>`).join('')}</div>
                    </div>
                    <div class="history-actions">
                       <button title="Pin" class="btn btn-sm" onclick="togglePinHistory(${entry.id})"><i class="fas fa-thumbtack ${entry.isPinned ? 'active' : ''}"></i></button>
                       <button title="Add/Edit Tags" class="btn btn-sm" onclick="tagHistoryItem(${entry.id})"><i class="fas fa-tag"></i></button>
                       <button title="Delete" class="btn btn-sm btn-danger" onclick="deleteHistoryItem(${entry.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            searchInput.oninput = renderGenerationHistory;
            sortSelect.onchange = renderGenerationHistory;
        }
        function deleteHistoryItem(id) { appState.generationHistory = appState.generationHistory.filter(e => e.id !== id); saveState(); renderGenerationHistory(); }
        function togglePinHistory(id) { const item = appState.generationHistory.find(e => e.id === id); if(item) { item.isPinned = !item.isPinned; } saveState(); renderGenerationHistory(); }
        function tagHistoryItem(id) { const item = appState.generationHistory.find(e => e.id === id); if(item) { const newTag = prompt('Enter comma-separated tags:', (item.tags || []).join(', ')); if(newTag !== null) { item.tags = newTag.split(',').map(t => t.trim()).filter(Boolean); } } saveState(); renderGenerationHistory(); }
        function exportHistory() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState.generationHistory)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "qr_history.json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
        
        // --- Settings Page ---
        function initSettingsPage() {
            document.getElementById('theme-selector').value = appState.settings.theme;
            document.getElementById('font-selector').value = appState.settings.font;
            document.getElementById('glassmorphism-toggle').checked = appState.settings.glassmorphism;
            document.getElementById('custom-css-editor').value = appState.settings.customCSS;
            document.getElementById('pin-input-setup').value = appState.settings.pinLock;
            document.getElementById('install-pwa-btn').onclick = installPWA;
            if(!deferredInstallPrompt) document.getElementById('install-pwa-btn').style.display = 'none';
        }
        function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); appState.settings.theme = theme; document.querySelector('meta[name="theme-color"]').setAttribute('content', theme === 'dark' ? '#121212' : '#007bff'); }
        function applyFont(font) { document.documentElement.style.setProperty('--font-family', font === 'serif' ? 'serif' : font === 'monospace' ? 'monospace' : 'sans-serif'); appState.settings.font = font; saveState(); }
        function toggleStyleClass(className, isEnabled) { document.documentElement.classList.toggle(className, isEnabled); appState.settings[className] = isEnabled; saveState(); }
        function applyCustomCSS(css) { document.getElementById('custom-user-css').innerHTML = css; appState.settings.customCSS = css; saveState(); }
        function savePin() { const pin = document.getElementById('pin-input-setup').value; if (/^\d{4}$/.test(pin) || pin.length === 0) { appState.settings.pinLock = pin; saveState(); alert(pin ? 'PIN saved.' : 'PIN removed.'); } else { alert('PIN must be 4 digits.'); } }
    
        // --- Utility & Helper Functions ---
        function pasteFromClipboard(elementId) { navigator.clipboard.readText().then(text => { document.getElementById(elementId).value = text; generateQR(true); }).catch(err => alert('Failed to read clipboard')); }
        function startSpeechRecognition(elementId) { if (!('webkitSpeechRecognition' in window)) { alert('Speech recognition not supported in this browser.'); return; } const recognition = new webkitSpeechRecognition(); recognition.continuous = false; recognition.lang = 'en-US'; recognition.interimResults = false; recognition.maxAlternatives = 1; recognition.onresult = (event) => { document.getElementById(elementId).value = event.results[0][0].transcript; generateQR(true); }; recognition.onspeechend = () => { recognition.stop(); }; recognition.onerror = (event) => { alert('Speech recognition error: ' + event.error); }; recognition.start(); }
        function readAloud(text) { if (!('speechSynthesis' in window)) { alert('Text-to-speech not supported.'); return; } window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); window.speechSynthesis.speak(utterance); }
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'), () => alert('Failed to copy.')); }
        function toggleFieldset(fieldsetId) { const fieldset = document.getElementById(fieldsetId); const content = fieldset.querySelector('.fieldset-content'); const icon = fieldset.querySelector('legend i:last-child'); if(content.style.display === 'block') { content.style.display = 'none'; icon.classList.replace('fa-chevron-up', 'fa-chevron-down'); } else { content.style.display = 'block'; icon.classList.replace('fa-chevron-down', 'fa-chevron-up'); } }
        function showModalMessage(title, content, onCloseCallback) { const modal = document.getElementById('scan-result-modal'); const contentDiv = document.getElementById('scan-result-content'); contentDiv.innerHTML = `<h3>${title}</h3><div>${content}</div><button class="btn btn-primary" style="margin-top:15px;" onclick="closeModal('scan-result-modal')">Close</button>`; modal.style.display = 'flex'; modal.onCloseCallback = onCloseCallback; }
        function closeModal(modalId) { const modal = document.getElementById(modalId); modal.style.display = 'none'; if(modal.onCloseCallback) { modal.onCloseCallback(); modal.onCloseCallback = null; } }
        
        // *** FIXED: This is the correct, secure version of the function. ***
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            const map = {
                '&': '&',
                '<': '<',
                '>': '>',
                '"': '"',
                "'": ''
            };
            return str.replace(/[&<>"']/g, (m) => map[m]);
        }
    
        async function digestMessage(message) { const msgUint8 = new TextEncoder().encode(message); const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); }
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) { var R = 6371; var dLat = (lat2-lat1) * (Math.PI/180); var dLon = (lon2-lon1) * (Math.PI/180); var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; }
        function emojiToDataUrl(emoji) { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); canvas.width = 64; canvas.height = 64; ctx.font = '56px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(emoji, 32, 36); return canvas.toDataURL('image/png'); }
        </script>
        </body>
        </html>
